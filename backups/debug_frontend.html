<!DOCTYPE html>
<html>
<head>
    <title>Debug - Attendance Manager</title>
    <style>
        body { font-family: Arial; padding: 20px; background: #0f172a; color: white; }
        .debug { background: #1e293b; padding: 15px; margin: 10px 0; border-radius: 8px; }
        button { padding: 10px 20px; margin: 5px; background: #6366f1; color: white; border: none; border-radius: 8px; cursor: pointer; }
        pre { background: #000; color: #0f0; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
    </style>
</head>
<body>
    <h1>üîç Frontend Debug Tool</h1>
    
    <div class="debug">
        <h3>Step 1: Check if API scripts are loaded</h3>
        <button onclick="checkScripts()">Check Scripts</button>
        <pre id="scriptCheck"></pre>
    </div>
    
    <div class="debug">
        <h3>Step 2: Test API Connection</h3>
        <button onclick="testAPI()">Test API</button>
        <pre id="apiTest"></pre>
    </div>
    
    <div class="debug">
        <h3>Step 3: Login</h3>
        <input type="email" id="email" placeholder="Email" style="padding:10px; margin:5px;">
        <input type="password" id="password" placeholder="Password" style="padding:10px; margin:5px;">
        <button onclick="testLogin()">Login</button>
        <pre id="loginTest"></pre>
    </div>
    
    <div class="debug">
        <h3>Step 4: Get Today's Data</h3>
        <button onclick="getTodayData()">Get Today's Data</button>
        <pre id="todayData"></pre>
    </div>
    
    <div class="debug">
        <h3>Step 5: Mark Attendance</h3>
        <input type="number" id="subjectId" placeholder="Subject ID" style="padding:10px; margin:5px;">
        <button onclick="markPresent()">Mark Present</button>
        <pre id="markResult"></pre>
    </div>

    <script src="http://127.0.0.1:8000/static/attendance/app-api.js"></script>
    <script src="http://127.0.0.1:8000/static/attendance/storage-adapter.js"></script>
    
    <script>
        function log(elementId, message, isError = false) {
            const el = document.getElementById(elementId);
            const color = isError ? 'error' : 'success';
            el.innerHTML += `<span class="${color}">${message}</span>\n`;
        }
        
        function checkScripts() {
            const el = document.getElementById('scriptCheck');
            el.innerHTML = '';
            
            log('scriptCheck', 'Checking if API scripts are loaded...');
            
            if (typeof AttendanceAPI !== 'undefined') {
                log('scriptCheck', '‚úì AttendanceAPI is loaded');
            } else {
                log('scriptCheck', '‚úó AttendanceAPI NOT loaded', true);
            }
            
            if (typeof apiStorage !== 'undefined') {
                log('scriptCheck', '‚úì apiStorage is loaded');
            } else {
                log('scriptCheck', '‚úó apiStorage NOT loaded', true);
            }
            
            if (typeof window.apiStorage !== 'undefined') {
                log('scriptCheck', '‚úì window.apiStorage is available');
            } else {
                log('scriptCheck', '‚úó window.apiStorage NOT available', true);
            }
        }
        
        async function testAPI() {
            const el = document.getElementById('apiTest');
            el.innerHTML = '';
            
            log('apiTest', 'Testing API connection...');
            
            try {
                const response = await fetch('http://127.0.0.1:8000/api/auth/me/', {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('apiTest', '‚úì API is reachable');
                    log('apiTest', 'Response: ' + JSON.stringify(data, null, 2));
                } else {
                    log('apiTest', '‚ö† API returned: ' + response.status);
                    log('apiTest', 'This is normal if not logged in');
                }
            } catch (err) {
                log('apiTest', '‚úó API connection failed: ' + err.message, true);
            }
        }
        
        async function testLogin() {
            const el = document.getElementById('loginTest');
            el.innerHTML = '';
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                log('loginTest', '‚úó Please enter email and password', true);
                return;
            }
            
            log('loginTest', 'Attempting login...');
            
            try {
                const result = await AttendanceAPI.Auth.login(email, password);
                log('loginTest', '‚úì Login successful!');
                log('loginTest', 'User: ' + JSON.stringify(result.user, null, 2));
                
                // Initialize storage
                await apiStorage.init();
                log('loginTest', '‚úì Storage initialized');
            } catch (err) {
                log('loginTest', '‚úó Login failed: ' + err.message, true);
            }
        }
        
        async function getTodayData() {
            const el = document.getElementById('todayData');
            el.innerHTML = '';
            
            log('todayData', 'Getting today\'s data...');
            log('todayData', 'Today is: ' + new Date().toDateString());
            
            try {
                const subjects = apiStorage.getSubjects();
                log('todayData', `‚úì Found ${subjects.length} subjects`);
                
                subjects.forEach(sub => {
                    const today = new Date().toDateString();
                    const status = sub.dates[today] || 'PENDING';
                    log('todayData', `  ${sub.name}: ${status}`);
                });
                
                const tt = apiStorage.getTimetable();
                const todayIdx = (new Date().getDay() + 6) % 7;
                const todayLectures = tt[todayIdx];
                log('todayData', `‚úì Today's lectures: ${todayLectures.length}`);
                
                todayLectures.forEach(lec => {
                    log('todayData', `  - ${lec.name} at ${lec.time}`);
                });
            } catch (err) {
                log('todayData', '‚úó Error: ' + err.message, true);
                log('todayData', 'Make sure you are logged in first!', true);
            }
        }
        
        async function markPresent() {
            const el = document.getElementById('markResult');
            el.innerHTML = '';
            
            const subjectId = parseInt(document.getElementById('subjectId').value);
            
            if (!subjectId) {
                log('markResult', '‚úó Please enter subject ID', true);
                return;
            }
            
            log('markResult', 'Marking attendance...');
            
            try {
                const today = new Date().toDateString();
                await apiStorage.markAttendance(subjectId, today, 'att');
                log('markResult', '‚úì Attendance marked!');
                
                // Refresh data
                await apiStorage.init(true);
                log('markResult', '‚úì Data refreshed');
                
                // Check status
                const subjects = apiStorage.getSubjects();
                const subject = subjects.find(s => s.id === subjectId);
                if (subject) {
                    const status = subject.dates[today] || 'PENDING';
                    log('markResult', `Status now: ${status}`);
                }
            } catch (err) {
                log('markResult', '‚úó Error: ' + err.message, true);
            }
        }
        
        // Auto-check on load
        window.onload = function() {
            checkScripts();
        };
    </script>
</body>
</html>
