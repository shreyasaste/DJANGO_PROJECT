<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Attendance Manager</title>
<style>
  /* 1. ULTRA MODERN GLASS THEME */
  :root {
    --primary: #6366f1;
    --primary-grad: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    --bg-dark: #0f172a;
    --glass-panel: rgba(30, 41, 59, 0.7);
    --glass-border: rgba(255, 255, 255, 0.08);
    --text-main: #f8fafc;
    --text-muted: #94a3b8;
    --neon-glow: 0 0 20px rgba(99, 102, 241, 0.25);
  }

  * { box-sizing: border-box; font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; -webkit-tap-highlight-color: transparent; }
  
  body { 
    margin: 0; padding: 0; 
    background-color: var(--bg-dark); 
    color: var(--text-main); 
    height: 100%; width: 100%; overflow-x: hidden; 
    padding-bottom: 110px;
    background-image: radial-gradient(circle at 0% 0%, rgba(99, 102, 241, 0.1), transparent 40%), 
                      radial-gradient(circle at 100% 100%, rgba(139, 92, 246, 0.1), transparent 40%);
    background-attachment: fixed;
  }

  .hidden { display: none !important; }
  .app { max-width: 480px; margin: 0 auto; min-height: 100vh; position: relative; }

  /* 2. AUTH SCREEN */
  #authPage {
    position: fixed; inset: 0; z-index: 5000;
    display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 25px;
    background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px);
  }
  .auth-card { 
    background: rgba(30, 41, 59, 0.5); backdrop-filter: blur(25px); 
    padding: 35px 30px; border-radius: 28px; width: 100%; max-width: 380px; 
    border: 1px solid var(--glass-border); 
    box-shadow: 0 30px 60px -12px rgba(0, 0, 0, 0.5); 
    display: flex; flex-direction: column; gap: 18px; animation: slideUp 0.5s ease-out;
  }
  @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

  .auth-header { text-align: center; margin-bottom: 5px; }
  .auth-title { margin: 0; font-weight: 800; font-size: 26px; color: #fff; letter-spacing: -0.5px; }
  .auth-sub { font-size: 13px; color: var(--text-muted); margin-top: 6px; }
  
  .input-group { position: relative; margin-top: 5px; }
  .input-label { position: absolute; top: -9px; left: 14px; background: #1e293b; padding: 0 6px; font-size: 10px; color: #a78bfa; font-weight: 700; text-transform: uppercase; border-radius: 4px; z-index: 2; }
  .auth-input { 
    width: 100%; padding: 16px; border-radius: 14px; border: 1px solid var(--glass-border); 
    background: rgba(15, 23, 42, 0.4); color: white; font-size: 15px; outline: none; transition: 0.3s;
  }
  .auth-input:focus { border-color: #8b5cf6; background: rgba(15, 23, 42, 0.6); box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.15); }
  .password-toggle { position: absolute; right: 16px; top: 16px; color: #64748b; cursor: pointer; }

  .primary-btn { 
    width: 100%; background: var(--primary-grad); color: white; padding: 16px; font-size: 15px; 
    border-radius: 14px; border: none; font-weight: 700; cursor: pointer; margin-top: 10px;
    box-shadow: var(--neon-glow); transition: transform 0.1s;
  }
  .primary-btn:active { transform: scale(0.98); }

  .switch-auth { text-align: center; font-size: 12px; color: var(--text-muted); margin-top: 10px; }
  .switch-link { color: #a78bfa; font-weight: 700; cursor: pointer; margin-left: 5px; }

  /* 3. HEADER & NAV */
  .header {
    padding: 15px 20px; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(15px);
    display: flex; justify-content: space-between; align-items: center;
    border-bottom: 1px solid var(--glass-border); position: sticky; top: 0; z-index: 100;
  }
  .header-left { display: flex; flex-direction: column; }
  #date { font-size: 18px; font-weight: 800; color: #fff; text-transform: uppercase; letter-spacing: 0.5px; }
  #overallPctHeader { font-size: 12px; font-weight: 700; color: #a78bfa; margin-top: 2px; }
  
  .header-right { display: flex; gap: 12px; align-items: center; }
  .target-badge { background: rgba(255,255,255,0.05); padding: 5px 10px; border-radius: 10px; text-align: center; border: 1px solid var(--glass-border); display:flex; flex-direction:column; align-items:center; justify-content:center; height: 38px; min-width: 45px;}
  .target-label { font-size: 7px; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 1px;}
  .target-val { font-size: 11px; font-weight: 900; color: #fff; }

  .plus-btn { width: 38px; height: 38px; border-radius: 12px; border: none; background: var(--primary-grad); color: white; cursor: pointer; font-size: 22px; display: flex; align-items: center; justify-content: center; box-shadow: var(--neon-glow); }
  .hamburger { width: 30px; height: 38px; display: flex; flex-direction: column; justify-content: center; gap: 6px; cursor: pointer; background: none; border: none; padding: 0; align-items: flex-end; }
  .hamburger span { display: block; width: 24px; height: 3px; background: #94a3b8; border-radius: 4px; }
  .hamburger span:nth-child(2) { width: 18px; }

  /* 4. DASHBOARD CARDS */
  .card { 
    background: var(--glass-panel); backdrop-filter: blur(12px); 
    border: 1px solid var(--glass-border); border-radius: 24px; padding: 20px; margin: 15px; 
    box-shadow: 0 10px 25px -5px rgba(0,0,0,0.3);
  }
  .card-top { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
  
  .pct-circle { 
    width: 55px; height: 55px; border-radius: 50%; background: rgba(15,23,42,0.5); 
    border: 3px solid #22c55e; display: flex; flex-direction: column; 
    align-items: center; justify-content: center; flex-shrink: 0;
    box-shadow: 0 0 10px rgba(34, 197, 94, 0.2);
  }
  .pct-val { font-size: 14px; font-weight: 900; line-height: 1; }
  .pct-goal { font-size: 9px; font-weight: 700; opacity: 0.6; }
  
  .subject-name { font-size: 16px; font-weight: 800; display: block; margin-bottom: 2px; }
  .advice-text { font-size: 12px; font-weight: 500; color: #94a3b8; }

  .subject-actions { display: flex; justify-content: flex-end; gap: 10px; }
  .icon-btn { 
    width: 38px; height: 38px; border-radius: 12px; border: 1px solid var(--glass-border); 
    background: rgba(255,255,255,0.03); cursor: pointer; display: flex; align-items: center; 
    justify-content: center; font-size: 16px; padding: 0; transition: 0.2s;
  }
  .btn-clear { color: #64748b; } .btn-off { color: #f59e0b; } .btn-miss { color: #ef4444; } .btn-att { color: #22c55e; }
  .icon-btn.active-att { background: #22c55e; color: #fff; border-color: #22c55e; }
  .icon-btn.active-miss { background: #ef4444; color: white; border-color: #ef4444; }
  .icon-btn.active-off { background: #f59e0b; color: #fff; border-color: #f59e0b; }

  /* 5. SUGGESTION & WELCOME CARDS STYLE */
  .suggestion-box {
    background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
    border-radius: 24px; padding: 30px 25px; margin: 15px; text-align: center;
    box-shadow: 0 15px 30px -10px rgba(99, 102, 241, 0.5);
    color: white; animation: slideUp 0.5s ease-out;
  }
  .sugg-icon { font-size: 36px; margin-bottom: 12px; }
  .sugg-text h4 { margin: 0; font-size: 24px; font-weight: 800; letter-spacing: -0.5px; }
  .sugg-text p { margin: 10px 0 22px 0; font-size: 14px; opacity: 0.95; line-height: 1.5; }
  .sugg-btn { 
    background: white; color: #6366f1; border: none; padding: 14px 28px; 
    border-radius: 22px; font-weight: 800; cursor: pointer; 
    box-shadow: 0 8px 20px rgba(0,0,0,0.15); transition: 0.2s;
  }
  .sugg-btn:active { transform: scale(0.96); }
  
  .alert-box {
    background: rgba(30, 41, 59, 0.7); border: 1px solid var(--glass-border);
    border-left: 4px solid; border-radius: 16px; padding: 15px; margin: 15px;
    display: flex; gap: 15px; align-items: center;
  }
  .alert-critical { border-color: #ef4444; } .alert-warning { border-color: #f59e0b; } .alert-safe { border-color: #22c55e; }
  
  .hint-pill {
    font-size: 10px; color: #a78bfa; background: rgba(167, 139, 250, 0.1); 
    padding: 6px 12px; border-radius: 20px; display: inline-block; 
    margin-bottom: 15px; border: 1px solid rgba(167, 139, 250, 0.2);
    font-weight: 700; letter-spacing: 0.5px;
  }

  /* 6. UI ELEMENTS */
  .tt-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; background: rgba(255,255,255,0.03); border-radius: 16px; margin-bottom: 10px; border: 1px solid var(--glass-border); }
  .tt-time { font-size: 11px; font-weight: 700; color: #38bdf8; background: rgba(56, 189, 248, 0.1); padding: 5px 8px; border-radius: 6px; }
  .day-tab { 
    flex: 1; min-width: 60px; padding: 12px; border-radius: 14px; 
    background: rgba(255,255,255,0.04); border: none; color: #94a3b8; 
    font-weight: 700; font-size: 12px; cursor: pointer; transition: 0.2s; 
  }
  .day-tab.active { background: var(--primary-grad); color: white; box-shadow: var(--neon-glow); }
  .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; text-align: center; }
  .dot { width: 5px; height: 5px; border-radius: 50%; margin: 4px auto 0; background: #334155; }
  .dot-att { background: #22c55e; } .dot-miss { background: #ef4444; }

  .footer-progress { position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(10px); border-top: 1px solid var(--glass-border); padding: 15px 20px; z-index: 50; }
  .progress-bg { background: rgba(255,255,255,0.1); height: 6px; border-radius: 10px; margin: 8px 0; overflow: hidden; }
  .progress-fill { background: var(--primary-grad); height: 100%; width: 0%; transition: 0.5s; box-shadow: var(--neon-glow); }

  /* 7. MODAL & INPUTS */
  .modal-overlay { 
    position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); 
    display: flex; align-items: center; justify-content: center; z-index: 8000; padding: 20px; 
  }
  .modal-card { 
    background: #1e293b; border: 1px solid var(--glass-border); 
    box-shadow: 0 25px 50px rgba(0,0,0,0.7); border-radius: 24px; padding: 25px; 
    width: 100%; max-width: 320px;
  }
  .modal-card h3 { margin-top: 0; margin-bottom: 15px; font-size: 16px; font-weight: 800; color: #fff; text-transform: uppercase; }
  .modal-input { 
    width: 100%; padding: 14px; border-radius: 12px; border: 1px solid #475569; 
    background: #0f172a; color: white; font-size: 16px; outline: none; margin: 10px 0;
  }
  .modal-input:focus { border-color: #6366f1; background: #1e293b; }
  .modal-list { max-height: 250px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; margin: 15px 0; }
  .modal-item { padding: 12px; background: rgba(255,255,255,0.05); border-radius: 10px; cursor: pointer; font-size: 14px; font-weight: 600; color: #cbd5e1; transition: all 0.2s; }
  .modal-item:hover { background: rgba(99, 102, 241, 0.2); color: #fff; transform: translateX(4px); }
  .modal-item:active { background: rgba(99, 102, 241, 0.4); }
  .modal-actions { display: flex; gap: 10px; margin-top: 15px; }
  .modal-btn { flex: 1; padding: 12px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
  .modal-btn.cancel { background: rgba(255,255,255,0.1); color: #94a3b8; }
  .modal-btn.ok { background: var(--primary-grad); color: white; }

  /* SELECT DROPDOWN STYLING */
  select {
    appearance: none;
    -webkit-appearance: none;
    -moz-appearance: none;
    background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 20px;
    cursor: pointer;
    font-size: 16px;
  }
  #targetDropdown {
    width: 100%;
    padding: 14px;
    padding-right: 40px;
    border-radius: 12px;
    background-color: rgba(255,255,255,0.05);
    color: white;
    border: 1px solid rgba(255,255,255,0.1);
    font-weight: 700;
    outline: none;
  }
  select:focus {
    border-color: #6366f1 !important;
    box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
  }
  select option {
    background: #1e293b;
    color: white;
    padding: 12px;
    font-weight: 700;
  }
  select option:hover {
    background: #334155;
  }
  select option:checked {
    background: #6366f1;
    color: white;
  }

  /* 8. PREDICTION POPUP */
  .pred-card { text-align: center; padding: 10px 0; }
  .pred-big-val { font-size: 48px; font-weight: 900; margin: 10px 0; display: block; letter-spacing: -1px; }
  .pred-label { font-size: 10px; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; }
  .pred-scenario { background: rgba(15, 23, 42, 0.5); padding: 10px; border-radius: 12px; margin-top: 15px; font-size: 12px; color: #cbd5e1; border: 1px solid var(--glass-border); }
  .hist-item { display: flex; justify-content: space-between; padding: 12px; border-bottom: 1px solid var(--glass-border); font-size: 13px; }
  .summary-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--glass-border); cursor: pointer; }

  /* 9. SIDE MENU */
  #menuOverlay { 
    position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 6000; 
    opacity: 0; pointer-events: none; transition: opacity 0.3s; 
  }
  #menuOverlay.active { opacity: 1; pointer-events: all; }
  .menu-drawer {
    position: absolute; top: 0; right: 0; bottom: 0; width: 260px;
    background: #1e293b; border-left: 1px solid var(--glass-border);
    transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
    display: flex; flex-direction: column; padding: 30px;
    box-shadow: -10px 0 40px rgba(0,0,0,0.6);
  }
  #menuOverlay.active .menu-drawer { transform: translateX(0); }
  .menu-item { font-size: 16px; font-weight: 700; margin: 12px 0; cursor: pointer; color: #e2e8f0; display: flex; align-items: center; justify-content: space-between; padding: 12px; border-radius: 12px; transition: 0.2s; }
  .menu-item:active { background: rgba(255,255,255,0.05); }
  .close-menu { align-self: flex-end; font-size: 24px; margin-bottom: 20px; cursor: pointer; color: #94a3b8; padding: 10px; }

  /* 10. SUBJECT LIST X BUTTON */
  .sub-list-item { display: flex; justify-content: space-between; align-items: center; padding: 20px 0; border-bottom: 1px solid var(--glass-border); }

</style>
</head>
<body>

<div id="customModal" class="modal-overlay hidden">
  <div class="modal-card">
    <h3 id="modalTitle">Select Option</h3>
    <div id="modalBody"></div>
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">CANCEL</button>
      <button class="modal-btn ok" id="modalOkBtn">OK</button>
    </div>
  </div>
</div>

<div id="authPage">
  <div id="registerView" class="auth-card">
    <div class="auth-header">
      <h2 class="auth-title">Create Account</h2>
      <p class="auth-sub">Start tracking your attendance today</p>
    </div>
    <div class="input-group">
      <label class="input-label">Full Name</label>
      <input type="text" id="regName" class="auth-input" placeholder="Enter your name">
    </div>
    <div class="input-group">
      <label class="input-label">Email Address</label>
      <input type="email" id="regEmail" class="auth-input" placeholder="Enter your email id">
    </div>
    <div class="input-group">
      <label class="input-label">Password</label>
      <input type="password" id="regPass" class="auth-input" placeholder="Min. 4 characters">
      <span class="password-toggle" onclick="togglePass('regPass')">üëÅ</span>
    </div>
    <div class="input-group">
      <label class="input-label">Confirm Password</label>
      <input type="password" id="regPassConf" class="auth-input" placeholder="Repeat password">
    </div>
    <button class="primary-btn" onclick="doRegister()">Sign Up</button>
    <div class="switch-auth">Already have an account? <span class="switch-link" onclick="switchAuth('login')">Sign In</span></div>
  </div>

  <div id="loginView" class="auth-card hidden">
    <div class="auth-header">
      <h2 class="auth-title">Welcome Back</h2>
      <p class="auth-sub">Enter credentials to access dashboard</p>
    </div>
    <div class="input-group">
      <label class="input-label">Email</label>
      <input type="email" id="loginEmail" class="auth-input" placeholder="Enter your email id">
    </div>
    <div class="input-group">
      <label class="input-label">Password</label>
      <input type="password" id="loginPass" class="auth-input" placeholder="Enter password">
      <span class="password-toggle" onclick="togglePass('loginPass')">üëÅ</span>
    </div>
    <button class="primary-btn" onclick="doLogin()">Sign In</button>
    <div class="switch-auth">New user? <span class="switch-link" onclick="switchAuth('register')">Create Account</span></div>
  </div>
</div>

<div id="mainApp" class="hidden">
  <div id="menuOverlay" onclick="if(event.target === this) closeMenu()">
    <div class="menu-drawer">
      <div class="close-menu" onclick="closeMenu()">‚úï</div>
      <div class="menu-item" onclick="nav('todayPage')">Today <span>‚Üí</span></div>
      <div class="menu-item" onclick="nav('ttPage')">Timetable <span>‚Üí</span></div>
      <div class="menu-item" onclick="nav('calendarPage')">Calendar <span>‚Üí</span></div>
      <div class="menu-item" onclick="nav('subjectsPage')">Subjects <span>‚Üí</span></div>
      <div class="menu-item" onclick="nav('settingsPage')">Settings <span>‚Üí</span></div>
    </div>
  </div>

  <div class="app">
    <div class="header">
      <div class="header-left"><div id="date"></div><div id="overallPctHeader">0% Overall</div></div>
      <div class="header-right">
        <div class="target-badge"><span class="target-label">Goal</span><span class="target-val" id="targetBadge">80%</span></div>
        <button class="plus-btn" onclick="handleUniversalAdd()">+</button>
        <button class="hamburger" onclick="toggleMenu()"><span></span><span></span><span></span></button>
      </div>
    </div>

    <div id="todayPage">
      <div id="smartSuggestionContainer"></div>
      <div id="todayContainer"></div>
    </div>
    
    <div id="ttPage" class="hidden">
      <div style="display:flex; gap:10px; padding:10px 15px; overflow-x:auto;" id="dayTabs"></div>
      <div class="card">
        <h3 id="ttDayTitle" style="margin:0; font-size:16px; color: #38bdf8; text-transform:uppercase;">Monday</h3>
        <p class="hint-pill" style="margin-top:10px;">üí° Tip: Tap time to edit ‚Ä¢ Tap X to remove</p>
        <div id="lectureList"></div>
      </div>
    </div>

    <div id="calendarPage" class="hidden">
      <div class="card"><h3>Calendar</h3><div id="calendarDays" class="calendar-grid"></div></div>
      <div id="daySummary" class="card hidden">
        <h3 id="summaryDate" style="margin:0; font-size:16px; color:#38bdf8;"></h3>
        <p class="hint-pill" style="margin-top:10px;">üí° Tip: Tap any subject below to change status</p>
        <div id="summaryList"></div>
      </div>
    </div>

    <div id="subjectsPage" class="hidden">
      <div class="card">
        <h3 style="margin:0 0 10px 0; font-weight: 800;">All Subjects</h3>
        <div class="hint-pill">üí° Tip: Tap subject name for History & Prediction</div>
        <div id="subjectList" style="margin-top:15px;"></div>
      </div>
    </div>
    
    <div id="settingsPage" class="hidden">
      <div class="card"><h3>Criteria</h3>
        <select id="targetDropdown" onchange="updateCriteria()">
          <option value="75">75%</option>
          <option value="80">80%</option>
          <option value="85">85%</option>
          <option value="90">90%</option>
        </select>
      </div>
      <div class="card">
        <button style="width:100%; padding:14px; border-radius:12px; background:rgba(255,255,255,0.1); color:white; border:none; margin-bottom:12px; font-weight:700;" onclick="logoutUser()">Log Out</button>
        <button style="width:100%; padding:14px; border-radius:12px; background:rgba(239, 68, 68, 0.2); color:#fca5a5; border:1px solid rgba(239, 68, 68, 0.3); font-weight:700;" onclick="resetAll()">Reset App Data</button>
      </div>
    </div>

    <div class="footer-progress">
      <div style="display:flex; justify-content:space-between; font-size:12px; font-weight:800; color:#cbd5e1;"><span>Performance</span><span id="footerPct">0%</span></div>
      <div class="progress-bg"><div id="footerBar" class="progress-fill"></div></div>
    </div>
  </div>
</div>


<!-- API Integration Scripts -->
<script src="http://127.0.0.1:8000/static/attendance/app-api.js"></script>
<script src="http://127.0.0.1:8000/static/attendance/storage-adapter.js"></script>

<script>
window.addEventListener('DOMContentLoaded', async () => {
  const DAYS=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];
  let targetGoal = 80, todayIdx = (new Date().getDay() + 6) % 7, currentDayIdx = todayIdx, activePage = "todayPage";
  let apiStorage = window.apiStorage;

  window.showModal = function(title, type, options = []) {
    return new Promise(resolve => {
      const overlay = document.getElementById('customModal'); const body = document.getElementById('modalBody'); const okBtn = document.getElementById('modalOkBtn');
      document.getElementById('modalTitle').innerText = title; body.innerHTML = ""; overlay.classList.remove('hidden');
      if (type === 'input') {
        const input = document.createElement('input'); input.className = 'modal-input'; input.placeholder = "Type here..."; body.appendChild(input); input.focus();
        okBtn.onclick = () => { resolve(input.value); closeModal(); };
      } 
      else if (type === 'time') {
        const input = document.createElement('input'); input.type = 'time'; input.className = 'modal-input'; input.style.textAlign = 'center';
        body.appendChild(input); input.focus();
        okBtn.onclick = () => { 
          const val = input.value;
          if(val) { let [h, m] = val.split(':'); let ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12; h = h ? h : 12; resolve(`${h}:${m} ${ampm}`); } 
          else { resolve(null); }
          closeModal(); 
        };
      }
      else if (type === 'list') {
        options.forEach((opt, idx) => {
          const item = document.createElement('div'); 
          item.className = 'modal-item'; 
          item.innerText = `${idx+1}. ${opt}`;
          item.style.userSelect = 'none';
          item.addEventListener('click', (e) => { 
            e.stopPropagation();
            console.log('Modal item clicked:', idx, opt);
            closeModal(); 
            resolve(idx); 
          }); 
          body.appendChild(item);
        });
        okBtn.classList.add('hidden');
      }
    });
  }
  window.closeModal = function() { document.getElementById('customModal').classList.add('hidden'); document.getElementById('modalOkBtn').classList.remove('hidden'); }

  window.switchAuth = function(mode) {
    if (mode === 'login') { document.getElementById('registerView').classList.add('hidden'); document.getElementById('loginView').classList.remove('hidden'); } 
    else { document.getElementById('loginView').classList.add('hidden'); document.getElementById('registerView').classList.remove('hidden'); }
  }

  window.togglePass = function(id) {
    const input = document.getElementById(id); input.type = input.type === "password" ? "text" : "password";
  }

  window.doRegister = async function() {
    const name = document.getElementById('regName').value.trim(); const email = document.getElementById('regEmail').value.trim(); const pass = document.getElementById('regPass').value; const conf = document.getElementById('regPassConf').value;
    if (!name) return alert("Name is required."); if (!email.includes('@') || !email.includes('.')) return alert("Please enter a valid email.");
    if (pass.length < 4) return alert("Password must be at least 4 characters."); if (pass !== conf) return alert("Passwords do not match.");
    try {
      await AttendanceAPI.Auth.register(name, email, pass);
      await unlock();
    } catch (err) {
      alert("Registration failed: " + err.message);
    }
  }

  window.doLogin = async function() {
    const inputEmail = document.getElementById('loginEmail').value.trim(); const inputPass = document.getElementById('loginPass').value;
    try {
      await AttendanceAPI.Auth.login(inputEmail, inputPass);
      await unlock();
    } catch (err) {
      alert("Login failed: " + err.message);
    }
  }

  window.unlock = async function() { 
    try {
      await apiStorage.init();
      document.getElementById('authPage').classList.add('hidden'); document.getElementById('mainApp').classList.remove('hidden');
      targetGoal = apiStorage.getTarget();
      document.getElementById('targetBadge').innerText = targetGoal + "%";
      document.getElementById('targetDropdown').value = targetGoal;
      renderAll();
    } catch (err) {
      alert("Failed to load data: " + err.message);
    }
  }

  document.getElementById('date').innerText = new Date().toLocaleDateString('en-GB', { weekday: 'short', day: 'numeric', month: 'short' });

  function getSubs(){ return apiStorage.getSubjects(); }
  function getTT(){ return apiStorage.getTimetable(); }

  window.nav = function(p){ activePage=p; ["todayPage","ttPage","calendarPage","subjectsPage","settingsPage"].forEach(id => document.getElementById(id).classList.add("hidden")); document.getElementById(p).classList.remove("hidden"); closeMenu(); renderAll(); }
  window.toggleMenu = function() { document.getElementById('menuOverlay').classList.toggle('active'); }
  window.closeMenu = function() { document.getElementById('menuOverlay').classList.remove('active'); }
  window.handleUniversalAdd = function() { if(activePage === "ttPage") addLecToTT(); else addSubject(); }

  window.switchDay = function(i) {
    currentDayIdx = i;
    renderTT();
  }

  window.renderSmartSuggestion = function() {
    const s = getSubs(); const tt = getTT();
    const cont = document.getElementById("smartSuggestionContainer");
    cont.innerHTML = "";
    
    const isTTEmpty = tt.every(day => day.length === 0);

    if(s.length === 0) {
      cont.innerHTML = `<div class="suggestion-box"><div class="sugg-icon">üëã</div><div class="sugg-text"><h4>Welcome!</h4><p>It's empty here. Add your subjects to start tracking.</p><button class="sugg-btn" onclick="addSubject()">+ Add First Subject</button></div></div>`;
      return;
    }

    if(isTTEmpty) {
       cont.innerHTML = `<div class="suggestion-box"><div class="sugg-icon">üìÖ</div><div class="sugg-text"><h4>Setup Schedule!</h4><p>Your subjects are ready. Now, add them to the timetable to track attendance.</p><button class="sugg-btn" onclick="nav('ttPage')">+ Setup Timetable</button></div></div>`;
       return;
    }

    let critical = null; let warning = null; 
    s.forEach(sub => {
      const tot = sub.att + sub.miss; if(tot === 0) return;
      const pct = (sub.att / tot) * 100;
      let need = Math.ceil((targetGoal * tot - 100 * sub.att) / (100 - targetGoal));
      let buffer = Math.floor((100 * sub.att / targetGoal) - tot);
      if (pct < targetGoal) { if (!critical || need > critical.need) critical = { ...sub, need, pct }; } 
      else if (buffer < 2) { if (!warning || buffer < warning.buffer) warning = { ...sub, buffer, pct }; }
    });

    if (critical) {
      cont.innerHTML = `<div class="alert-box alert-critical"><div style="font-size:24px">üö®</div><div><h4 style="margin:0; font-size:14px">Focus on ${critical.name}</h4><p style="margin:2px 0 0 0; font-size:11px; opacity:0.8">You are at ${Math.round(critical.pct)}%. Attend next <b>${critical.need}</b> classes.</p></div></div>`;
    } else if (warning) {
      cont.innerHTML = `<div class="alert-box alert-warning"><div style="font-size:24px">‚ö†Ô∏è</div><div><h4 style="margin:0; font-size:14px">Warning for ${warning.name}</h4><p style="margin:2px 0 0 0; font-size:11px; opacity:0.8">${warning.buffer === 0 ? "Attendance tight! No bunks left." : `Only ${warning.buffer} bunk(s) away from danger.`}</p></div></div>`;
    } else {
      cont.innerHTML = `<div class="alert-box alert-safe"><div style="font-size:24px">‚úÖ</div><div><h4 style="margin:0; font-size:14px">You are Safe!</h4><p style="margin:2px 0 0 0; font-size:11px; opacity:0.8">All subjects are above ${targetGoal}%.</p></div></div>`;
    }
  }

  window.renderAll = function(){
    renderSmartSuggestion();
    const subs = getSubs(), tt = getTT(), todayLecs = tt[todayIdx], todayCont = document.getElementById("todayContainer"), subCont = document.getElementById("subjectList");
    todayCont.innerHTML = subCont.innerHTML = ""; let tA = 0, tL = 0;
    
    if (todayLecs.length === 0 && subs.length > 0) { 
        todayCont.innerHTML = `<div class="card" style="text-align:center; padding:40px; color:#94a3b8;"><b>No lectures today.</b><br><span style="font-size:11px; opacity:0.6;">Enjoy your day!</span></div>`; 
    } 
    else {
      todayLecs.forEach((lec) => {
        const i = subs.findIndex(s => s.name === lec.name);
        if (i !== -1) {
          const s = subs[i], tot = s.att + s.miss, pct = tot ? Math.round((s.att/tot)*100) : 0, status = s.dates?.[new Date().toDateString()] || "";
          todayCont.innerHTML += `<div class="card"><div class="card-top"><div class="pct-circle" style="border-color:${pct < targetGoal ? '#ef4444' : '#22c55e'}"><span class="pct-val">${pct}</span><span class="pct-goal">${targetGoal}</span></div><div class="subject-info"><span class="subject-name" onclick="openSubOptions(${i})" style="cursor:pointer; text-decoration:underline; text-decoration-style:dotted; text-decoration-color:#a78bfa;">${s.name}</span><span style="font-size:11px; color:#38bdf8; display:block; margin-bottom:5px;">${lec.time || 'Time not set'}</span></div></div><div class="subject-actions"><button class="icon-btn btn-clear" onclick="mark(${i},'clear')">üö´</button><button class="icon-btn btn-off ${status==='off'?'active-off':''}" onclick="mark(${i},'off')">‚ûñ</button><button class="icon-btn btn-miss ${status==='miss'?'active-miss':''}" onclick="mark(${i},'miss')">‚úñ</button><button class="icon-btn btn-att ${status==='att'?'active-att':''}" onclick="mark(${i},'att')">‚úî</button></div></div>`;
        }
      });
    }
    subs.forEach((s, i) => { tA += s.att; tL += (s.att + s.miss); subCont.innerHTML += `<div class="sub-list-item"><span style="font-weight:800; color:#fff; cursor:pointer; text-decoration:underline; text-decoration-style:dotted; text-decoration-color:#a78bfa;" onclick="openSubOptions(${i})">${s.name}</span><span style="color:#ef4444; font-size:18px; font-weight:bold; cursor:pointer;" onclick="deleteSubject(${i})">‚úï</span></div>`; });
    const overall = tL ? Math.round((tA/tL)*100) : 0;
    document.getElementById("overallPctHeader").innerText = overall + "% Overall";
    document.getElementById("footerPct").innerText = overall + "%"; document.getElementById("footerBar").style.width = (overall > 100 ? 100 : overall) + "%";
    if(activePage === "calendarPage") renderCalendar(); if(activePage === "ttPage") renderTT();
  }

  window.mark = async function(i,type){
    const s=getSubs(), today=new Date().toDateString(), subject = s[i];
    try {
      await apiStorage.markAttendance(subject.id, today, type);
      await apiStorage.init(true); // Force refresh
      renderAll();
    } catch (err) {
      alert("Failed to mark attendance: " + err.message);
      console.error('Mark attendance error:', err);
    }
  }

  window.addSubject = async function(){ 
    const name = await showModal("Add Subject", "input"); 
    if(name){ 
      try {
        await apiStorage.addSubject(name);
        await apiStorage.init();
        renderAll();
      } catch (err) {
        alert("Failed to add subject: " + err.message);
      }
    } 
  }
  
  window.deleteSubject = async function(i) { 
    if(confirm("Delete subject?")) { 
      const s=getSubs();
      try {
        await apiStorage.deleteSubject(s[i].id);
        await apiStorage.init();
        renderAll();
      } catch (err) {
        alert("Failed to delete subject: " + err.message);
      }
    } 
  }

  window.renderTT = function() {
    const tabs = document.getElementById("dayTabs"), list = document.getElementById("lectureList"); tabs.innerHTML = list.innerHTML = "";
    DAYS.forEach((d, i) => tabs.innerHTML += `<button class="day-tab ${i === currentDayIdx ? 'active' : ''}" onclick="switchDay(${i})">${d}</button>`);
    const now = new Date(); const targetDate = new Date(now); targetDate.setDate(now.getDate() + (currentDayIdx - ((now.getDay() + 6) % 7)));
    document.getElementById("ttDayTitle").innerText = `${DAYS[currentDayIdx]} (${targetDate.toLocaleDateString('en-GB', { day: 'numeric', month: 'short' })})`;
    const dayTT = getTT()[currentDayIdx];
    if (dayTT.length === 0) { list.innerHTML = `<div style="text-align:center; padding:30px; color:#94a3b8; font-weight:700;">No lectures scheduled</div>`; } 
    else { dayTT.forEach((l, i) => { list.innerHTML += `<div class="tt-item"><div style="flex:1"><div style="font-weight:900;">${l.name}</div><div class="tt-time" onclick="editLecTime(${currentDayIdx}, ${i})">${l.time || 'Set Time'}</div></div><span style="color:#ef4444; font-size:18px; cursor:pointer; font-weight:bold; margin-left:15px;" onclick="delLec(${i})">‚úï</span></div>`; }); }
  }

  window.addLecToTT = async function() {
    const subs = getSubs(); if(subs.length === 0) return alert("Add subjects first!");
    const idx = await showModal("Select Subject", "list", subs.map(s => s.name));
    if(idx !== undefined){ 
      const time = await showModal("Set Lecture Time", "time"); 
      try {
        await apiStorage.addLecture(currentDayIdx, subs[idx].name, time || "Time not set");
        await apiStorage.init();
        renderAll();
      } catch (err) {
        alert("Failed to add lecture: " + err.message);
      }
    }
  }

  window.editLecTime = async function(dayI, lecI) {
    const newTime = await showModal("Edit Lecture Time", "time"); 
    if (newTime !== null) { 
      const tt = getTT(); const lecture = tt[dayI][lecI];
      try {
        await apiStorage.updateLectureTime(lecture.id, newTime);
        await apiStorage.init();
        renderAll();
      } catch (err) {
        alert("Failed to update time: " + err.message);
      }
    }
  }

  window.delLec = async function(idx) { 
    const tt = getTT(); const lecture = tt[currentDayIdx][idx];
    try {
      await apiStorage.deleteLecture(lecture.id);
      await apiStorage.init();
      renderTT();
    } catch (err) {
      alert("Failed to delete lecture: " + err.message);
    }
  }

  window.renderCalendar = function() {
    const grid = document.getElementById("calendarDays"); grid.innerHTML = ""; const d = new Date(); let firstDay = (new Date(d.getFullYear(), d.getMonth(), 1).getDay() + 6) % 7;
    for(let i=0; i<firstDay; i++) grid.innerHTML += "<div></div>";
    const subs = getSubs();
    for(let i=1; i<=new Date(d.getFullYear(), d.getMonth()+1, 0).getDate(); i++) {
      const dStr = new Date(d.getFullYear(), d.getMonth(), i).toDateString(); let status = null; 
      subs.forEach(s => { if(s.dates && s.dates[dStr]) status = s.dates[dStr]; });
      grid.innerHTML += `<div style="padding:10px 0; cursor:pointer;" onclick="showDaySummary('${dStr}')"><div>${i}</div><div class="dot ${status==='att'?'dot-att':(status==='miss'?'dot-miss':(status==='off'?'dot-off':''))}"></div></div>`;
    }
  }

  window.showDaySummary = function(dateStr) {
    const summaryDiv = document.getElementById("daySummary"), list = document.getElementById("summaryList");
    summaryDiv.classList.remove("hidden"); document.getElementById("summaryDate").innerText = dateStr; list.innerHTML = "";
    const selectedDayIdx = (new Date(dateStr).getDay() + 6) % 7; const scheduledNames = getTT()[selectedDayIdx].map(lec => lec.name);
    getSubs().forEach(s => { if(scheduledNames.includes(s.name)) { let status = (s.dates && s.dates[dateStr]) ? s.dates[dateStr] : "none"; let label = status==='att'?'PRESENT':(status==='miss'?'ABSENT':(status==='off'?'OFF DAY':'PENDING')); let col = status==='att'?'#22c55e':(status==='miss'?'#ef4444':(status==='off'?'#f59e0b':'#94a3b8')); list.innerHTML += `<div class="summary-item" onclick="editPastAttendance('${s.name}', '${dateStr}')"><b>${s.name}</b><span style="color:${col}; font-weight:900;">${label}</span></div>`; } });
    if(list.innerHTML === "") list.innerHTML = `<p style="text-align:center; color:#94a3b8; font-size:12px;">No lectures scheduled.</p>`;
  }

  window.editPastAttendance = async function(subName, dateStr) {
    const s = getSubs(); const subject = s.find(sub => sub.name === subName); if(!subject) return;
    const opt = await showModal(`Edit ${subName}`, "list", ["Present", "Absent", "Off Class", "Clear"]);
    if(opt === undefined) return;
    const statusMap = ['att', 'miss', 'off', 'clear']; const status = statusMap[opt];
    try {
      await apiStorage.markAttendance(subject.id, dateStr, status);
      await apiStorage.init();
      renderAll();
      showDaySummary(dateStr);
    } catch (err) {
      alert("Failed to update attendance: " + err.message);
    }
  }

  window.updateCriteria = async function() { 
    const newTarget = parseInt(document.getElementById('targetDropdown').value);
    try {
      await apiStorage.updateTarget(newTarget);
      targetGoal = newTarget;
      document.getElementById('targetBadge').innerText = targetGoal + "%";
      renderAll();
    } catch (err) {
      alert("Failed to update target: " + err.message);
    }
  }
  
  window.logoutUser = async function() {
    try {
      // Call logout API to clear server session
      await AttendanceAPI.Auth.logout();
      console.log("Logout successful");
    } catch (err) {
      console.error("Logout API error:", err);
      // Continue with client-side cleanup even if API fails
    }
    
    // Clear all cached data
    if (window.apiStorage) {
      window.apiStorage.cache = {
        subjects: [],
        lectures: [],
        records: [],
        target: 80,
        user: null
      };
      window.apiStorage.initialized = false;
    }
    
    // Clear all storage
    sessionStorage.clear();
    localStorage.clear();
    
    // Hide main app and show auth page immediately
    document.getElementById('mainApp').classList.add('hidden');
    document.getElementById('authPage').classList.remove('hidden');
    
    // Switch to login view
    switchAuth('login');
    
    // Force reload after a short delay to ensure clean state
    setTimeout(() => {
      window.location.href = window.location.href.split('?')[0];
    }, 200);
  }
  
  window.resetAll = async function() { 
    if(confirm("Erase all data and logout?")) { 
      try {
        await AttendanceAPI.Auth.logout();
        location.reload();
      } catch (err) {
        alert("Logout failed: " + err.message);
      }
    } 
  }

  window.openSubOptions = function(i) {
    showModal("Options", "list", ["View History", "Predict Future"]).then(opt => { if(opt === 0) showHistory(i); if(opt === 1) predictFuture(i); });
  }

  window.showHistory = function(i) {
    const s = getSubs()[i]; const dates = Object.entries(s.dates || {}).sort((a,b) => new Date(b[0]) - new Date(a[0]));
    let html = `<div style="max-height:300px; overflow-y:auto;">`;
    if(dates.length === 0) html += `<div style="padding:20px; text-align:center; color:#94a3b8;">No history yet.</div>`;
    dates.forEach(([d, status]) => {
        let cls = status==='att'?'hist-att':(status==='miss'?'hist-miss':'hist-off'); let txt = status==='att'?'PRESENT':(status==='miss'?'ABSENT':'OFF');
        html += `<div class="hist-item"><span style="color:#cbd5e1">${d}</span><span class="${cls}" style="font-weight:900;">${txt}</span></div>`;
    });
    html += `</div>`;
    document.getElementById('modalTitle').innerText = s.name + " History"; document.getElementById('modalBody').innerHTML = html;
    document.getElementById('customModal').classList.remove('hidden'); document.getElementById('modalOkBtn').classList.remove('hidden'); document.getElementById('modalOkBtn').onclick = closeModal;
  }

  window.predictFuture = async function(i) {
    const s = getSubs()[i]; const attend = await showModal("Attending next X classes?", "input"); if(!attend) return;
    const miss = await showModal("Missing next Y classes?", "input"); if(!miss) return;
    const a = parseInt(attend)||0, m = parseInt(miss)||0, curTot = s.att + s.miss, newAtt = s.att + a, newTot = curTot + a + m, newPct = newTot === 0 ? 0 : Math.round((newAtt/newTot)*100);
    const color = newPct >= targetGoal ? '#22c55e' : '#ef4444';
    const html = `<div class="pred-card"><span class="pred-label">PROJECTED RESULT</span><span class="pred-big-val" style="color:${color}">${newPct}%</span><div class="pred-scenario">IF YOU ATTEND <b>${a}</b> AND MISS <b>${m}</b></div></div>`;
    document.getElementById('modalTitle').innerText = s.name.toUpperCase(); document.getElementById('modalBody').innerHTML = html;
    document.getElementById('customModal').classList.remove('hidden'); document.getElementById('modalOkBtn').classList.remove('hidden'); document.getElementById('modalOkBtn').onclick = closeModal;
  }

  // Initialize auth
  try {
    const user = await AttendanceAPI.Auth.getMe();
    if (user) {
      await unlock();
    }
  } catch (err) {
    switchAuth('login');
  }
});</script>
</body>
</html>